params:
  PLATFORM: xenial

python:
  virtualenv: .venv

package-root: ./.tox/_staging

enable-metatron: true
publish-image: dockerregistry.test.net:7002/engtools/nflx-ospackage:latest

# if .PackageVersion is like 1.0.0+h123-abcd123 then we just want the h123-abcd123 part
# otherwise if there is no '+' then we just report an empty release string to default
package-release: |
  {{$x := (.PackageVersion | split "+") }}{{if lt (len $x) 2}}{{else}}{{index $x 1}}{{end}}

post-commands:
  init:
    - '{{.NewtConfigsDir}}/python-cli/scripts/ensure-initial-commit'

command-configs:
  init:
    tool-versions:
      python: 3.6
    python:
      test-versions:
        - 3.6
    install-tools: false
    init:
      image: dockerregistry.test.net:7002/engtools/newt-python-init
      command-options:
        - https://stash.corp.com/scm/nfpy/cookiecutter-newt-python-cli.git

  clean:
    build-step:
      - rm -rf .eggs .gradle .tox .venv build dist *.egg-info */*.egg-info

  venv:
    build-step:
      - newt tox -e venv

  stage:
    enable-build-volumes: true
    build-image: dockerregistry.test.net:7002/engtools/newt-common-builder/{{.Params.PLATFORM}}:latest
    build-step:
      - |-
        set -ex
        if [[ -z `grep testenv:package tox.ini` ]]; then
          echo "Nothing to stage: tox target 'package' does not exist"
        else
          sudo /apps/python{{.ToolVersions.python}}/bin/python -m pip --cache-dir=/storage/pip-root install tox
          /apps/python{{.ToolVersions.python}}/bin/python -m tox -r -e package --workdir .tox/_docker
        fi

  test:
    enable-build-volumes: true
    build-image: dockerregistry.test.net:7002/engtools/newt-common-builder/{{.Params.PLATFORM}}:latest
    build-setup:
      - sudo /apps/python{{.ToolVersions.python}}/bin/python -m pip install --cache-dir=/storage/pip-root -i https://smartiproxy.mgmt.net/pypi tox
    build-step:
      - /apps/python{{.ToolVersions.python}}/bin/python -m tox --workdir .tox/_docker

  package all:
    build-step:
      - |-
        set -ex
        {{range $v := .Python.TestVersions -}}
          {{if hasPrefix $v "2.7" -}}newt package py27 ; {{end -}}
          {{if hasPrefix $v "3.4" -}}newt package py34 ; {{end -}}
          {{if hasPrefix $v "3.5" -}}newt package py35 ; {{end -}}
          {{if hasPrefix $v "3.6" -}}newt package py36 ; {{end -}}
        {{end -}}
        if [[ -n `grep testenv:package tox.ini` ]]; then
          newt stage
          rm -rf {{.PackageRoot}}
          mkdir -p {{.PackageRoot}}
          if [ -d root/ ]; then rsync -arH root/ {{.PackageRoot}}; fi
          if [ -d .tox/_docker/package/root/ ]; then rsync -arH .tox/_docker/package/root/ {{.PackageRoot}}; fi
          newt package debian
          mkdir -p .tox/_docker/_reports
          if [[ -d .gradle/distributions/ ]]; then
            cp -r .gradle/distributions/* .tox/_docker/_reports/
          elif [[ -d build/distributions/ ]]; then
            cp -r build/distributions/* .tox/_docker/_reports/
          fi
        fi

  package py27:
    build-image: dockerregistry.test.net:7002/engtools/newt-pywheel-builder:latest
    build-step: mkwheel --py 2.7 --build

  package py34:
    build-image: dockerregistry.test.net:7002/engtools/newt-pywheel-builder:latest
    build-step: mkwheel --py 3.4 --build

  package py35:
    build-image: dockerregistry.test.net:7002/engtools/newt-pywheel-builder:latest
    build-step: mkwheel --py 3.5 --build

  package py36:
    build-image: dockerregistry.test.net:7002/engtools/newt-pywheel-builder:latest
    build-step: mkwheel --py 3.6 --build

  publish all:
    build-step:
      - |-
        set -ex
        {{range $v := .Python.TestVersions -}}
          {{if hasPrefix $v "2.7" -}}newt publish py27 ; {{end -}}
          {{if hasPrefix $v "3.4" -}}newt publish py34 ; {{end -}}
          {{if hasPrefix $v "3.5" -}}newt publish py35 ; {{end -}}
          {{if hasPrefix $v "3.6" -}}newt publish py36 ; {{end -}}
        {{end -}}
        if [[ -n `grep testenv:package tox.ini` ]]; then newt publish debian; fi

  publish py27:
    build-image: dockerregistry.test.net:7002/engtools/newt-pywheel-builder:latest
    build-step: mkwheel --py 2.7 --publish

  publish py34:
    build-image: dockerregistry.test.net:7002/engtools/newt-pywheel-builder:latest
    build-step: mkwheel --py 3.4 --publish

  publish py35:
    build-image: dockerregistry.test.net:7002/engtools/newt-pywheel-builder:latest
    build-step: mkwheel --py 3.5 --publish

  publish py36:
    build-image: dockerregistry.test.net:7002/engtools/newt-pywheel-builder:latest
    build-step: mkwheel --py 3.6 --publish

  publish dependencies:
    build-image: dockerregistry.test.net:7002/engtools/newt-pywheel-builder:latest
    build-step: allmkwheel --build ; allmkwheel --publish

  publish on-tag:
    build-step: if [[ -n `git describe --long | grep -- -g` ]]; then echo "Not publishing, not on tagged commit"; else newt publish; fi

  pycharm:
    build-step:
      - |-
        if [[ -e /Applications/PyCharm.app/Contents/MacOS/pycharm ]]; then
          /Applications/PyCharm.app/Contents/MacOS/pycharm `pwd` 2> /dev/null
        else
          echo "PyCharm is not installed, get it via: brew cask install pycharm"
        fi

  zsinfo:
    build-step:
      - '{{.NewtConfigsDir}}/python-cli/scripts/info {{.Python.TestVersions}}'

  zsinfod:
    build-image: dockerregistry.test.net:7002/engtools/newt-common-builder/{{.Params.PLATFORM}}:latest
    build-step:
      - $HOME/.newt-cache/app-types/python-cli/scripts/info branch:{{.GitBranch}}

commands:
  - name: init
    id: default_init
  - name: clean
    id: build-newt
  - name: venv
    id: build-newt
  - name: test
    id: build-in-docker
  - name: stage
    id: build-in-docker
  - name: package
    sub-commands:
      - name: all
        id: build-newt
        default: true
      - name: py27
        id: build-in-docker
      - name: py34
        id: build-in-docker
      - name: py35
        id: build-in-docker
      - name: py36
        id: build-in-docker
      - name: debian
        id: default_package
  - name: publish
    sub-commands:
      - name: all
        id: build-newt
        default: true
      - name: py27
        id: build-in-docker
      - name: py34
        id: build-in-docker
      - name: py35
        id: build-in-docker
      - name: py36
        id: build-in-docker
      - name: debian
        id: default_publish
      - name: on-tag
        id: build-newt
      - name: dependencies
        id: build-in-docker
  - name: pycharm
    id: build-newt
    help: Open this project in PyCharm
  - name: zsinfo
    id: build-newt
  - name: zsinfod
    id: build-in-docker
  - name: python
    id: default_exec
  - name: tox
    id: default_exec
  - name: pip
    id: default_exec
  - name: exec
    id: default_exec
